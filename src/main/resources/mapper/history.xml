<?mapper version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="history">

    <select id="selectHistoryWithPaging" resultType="com.team5.sparcs.pico.domain.ChatBotVO" parameterType="map">
        SELECT
            a.*,
            b.chatbot_summery_id,
            b.summery,
            b.summery_chip,
            c.scienceName,
            c.description,
            c.imgUrl,
            c.backImg,
            c.chatImg,
            c.welcome
        FROM
            chatbot a
                LEFT JOIN (
                SELECT
                    chatbot_id,
                    chatbot_summery_id,
                    summery,
                    summery_chip
                FROM
                    chatbot_summery cs1
                WHERE
                    chatbot_summery_id = (
                        SELECT MAX(chatbot_summery_id)
                        FROM chatbot_summery cs2
                        WHERE cs2.chatbot_id = cs1.chatbot_id
                    )
            ) b ON a.chatbot_room_id = b.chatbot_id
                LEFT JOIN Scientist c ON a.scientistName = c.scienceName
        ORDER BY
            a.chatbot_room_id
            LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="countHistory" resultType="long">
        select count(*)
        from (SELECT a.*,
                     b.chatbot_summery_id,
                     b.summery,
                     b.summery_chip,
                     c.scienceName,
                     c.description,
                     c.imgUrl,
                     c.backImg,
                     c.chatImg,
                     c.welcome
              FROM chatbot a
                       LEFT JOIN (SELECT chatbot_id,
                                         chatbot_summery_id,
                                         summery,
                                         summery_chip
                                  FROM chatbot_summery cs1
                                  WHERE chatbot_summery_id = (SELECT MAX(chatbot_summery_id)
                                                              FROM chatbot_summery cs2
                                                              WHERE cs2.chatbot_id = cs1.chatbot_id)) b
                                 ON a.chatbot_room_id = b.chatbot_id
                       LEFT JOIN Scientist c ON a.scientistName = c.scienceName) ar

    </select>

    <select id="selectHistoryByChatbotId" resultType="com.team5.sparcs.pico.domain.ChatBotVO" parameterType="map">
        select * from chatbot_summery where chatbot_id = #{chatbotId}
    </select>
</mapper>
